# Federal COVID Money Received {#sec-covid-federal-funds}

```{r warning=FALSE, message=FALSE, echo=FALSE}
knitr::opts_chunk$set(warning=FALSE, message = FALSE)
library(tidyverse)
library(haven)

library(lubridate)
library(smooth)
library(forecast)
library(scales)

library(ggplot2)
library(readxl)
library(tidyverse)
library(data.table)
library(quantmod)
library(geofacet)
library(fredr)
library(sf)
library(usmap)
library(janitor)

library(RColorBrewer)
library(ggsankey)
library(ggalluvial)
library(readxl)
```

Dropping revenue source "Federal Stimulus Package" from the IOC revenue data is one way to start estimating how revenue will look after the COVID relief ends. The graphs below show Illinois revenue with and without Federal Stimulus Package revenue. It is important to note that only the \$8.127 ARPA State CURE and \$3.519 CARES CRF/State CURE revenue were labeled as "Federal Stimulus Package" in the IOC revenue data. There was still an additional \$12 billion dollars in other federal revenue that went to the state in FY22 compared to FY19. When trying to understand the states finances and the yearly fiscal gap, we also need to understand when and where the funds were considered revenue in the IOC data and consider the fiscal year that the funds were spent. Finally, allocations or expenditures may be grouped and labeled differently by the State compared to the Fiscal Futures project categorization. Some items that the federal relief funds are spent on are not included in Fiscal Gap calculations (e.g. the Unemployment Insurance Trust Fund repayments). The biggest challenge when determining the Fiscal Gap for Illinois centers around the timing of revenue and expenditures occurring in different fiscal years during the COVID response.

```{r}


rev_temp <- read_csv("rev_temp.csv") %>% 
  filter(agency!= "799")

drop_type <- c("32", "45", "51", 
               "66", "72", "75", "79", "98")

# drops Blank, Student Fees, Retirement contributions, proceeds/investments,
# bond issue proceeds, interagency receipts, cook IGT, Prior year refunds.


rev_temp <- rev_temp %>% filter(!rev_type %in% drop_type)

fedrev<- rev_temp %>% 
  # all federal revenue
  filter(rev_type == "58" | rev_type == "59" | rev_type == "57") 

fedrev %>% 
  group_by(fy) %>% 
  summarise(receipts = sum(receipts/1000, na.rm = TRUE)/1000000) %>% 
  ggplot() +
  geom_line(aes(x=fy, y=receipts)) +
      theme_bw() +
  scale_y_continuous(labels = comma)+
  labs(title = "All Federal Revenue", 
       y = "Billions of Dollars", x = "") + 
  theme(legend.position = "bottom", legend.title = element_blank()  )+
    scale_y_continuous(limits = c(0,45))


fedrev %>% 
  filter(source_name_AWM != "FEDERAL STIMULUS PACKAGE" & agency!="799") %>%
  group_by(fy) %>% 
  summarise(receipts = sum(receipts/1000, na.rm = TRUE)/1000000) %>% 
  ggplot() +
  geom_line(aes(x=fy, y=receipts)) +
      theme_bw() +
  scale_y_continuous(labels = comma)+
  labs(title = "All Federal EXCEPT Federal Stimulus Package", 
       y = "Billions of Dollars", x = "",
       caption = "Note: Dropping Federal Stimulus Package revenue only removes the $3.519 billion from FY20, 
       $0.23 billion from FY21, and $8.85 billion from FY22. Also drops Great Recession Aid in 2009.
       There is still $11.4 billion more in FY22 Federal Revenue compared to FY19.") + 
  theme(legend.position = "bottom", legend.title = element_blank()  ) +
  scale_y_continuous(limits = c(0,45))


fedrev %>% 
  filter(fy>2018) %>% # all fed rev after 2018 summed by year
  group_by(fy) %>% 
  summarize(Revenue = sum(receipts))

fedrev %>% 
  #federal stimulus revenue sources after 2018
  filter(source_name_AWM == "FEDERAL STIMULUS PACKAGE" & fy>2018) %>%
  group_by(fy) %>% 
  summarise(receipts = sum(receipts, na.rm = TRUE)/1000000)

fedrev %>% 
  filter(fy>2018) %>%
  group_by(fy, fund_name) %>% 
  summarise(receipts = sum(receipts, na.rm = TRUE)/1000000) %>%
  arrange(-receipts) %>%
  pivot_wider(names_from = fy, values_from = receipts)

```

![With and Without State CURE Funds from Federal Stimulus Packages](images/image-1706772717.png)

## Comptroller Revenue Data

Read the charts from the top to the bottom. Most of the graphs below begin with either the year the money was committed or the name of the Law that provided the funds and then shows it flowing down to either who received the money or how it was spent.

`Sankeyattempt2022.csv` file totals \$32 billion flowing into the state. \$3.5 came in FY20, \$12.6 billion came in FY21 and \$16.1 billion in FY22. These values include both the State CURE and other federal grants to state departments for education, health providers, and much more. These observations are based more on the IOC revenue data for revenue received.

PPP & Health Care Enhancement act contributed to \$2.778 billion for Provider Relief Fund. This is considered within the Medicare category in both revenues and expenditures.

Families First Act: \$4.469 billion for Medicaid (from Health and Human Services and deposited into Healthcare Provider Relief fund; Data Source IOC revenue data). This fund-revenue source combo grew from \$4 billion in 2019, \$6 billion in 2020, \$7.5 billion in 2021 and \$8.4 billion 2022.

CARES & ESSER impacts: Revenue from source "Department of Education-Fed" and deposited into "SBE Federal Dept of Education". Was \$1.45 billion in 2019 and 2020 and grew to \$2.26 billion in 2021 and \$3.35 billion in 2022.

::: callout-note
*Variable names in the sankeyattempt2022 file are not accurately named due to the information within morphing over time as I figured out the format to necessary for making the graphs. Any variable names used while making these graphs might not actually contain the data one would expect given the variable names. I do intend on renaming the file and changing the variable names and code but have not had time to complete that task.*
:::

According to [federal data publicly available](covidmoneytracker.org), \$52 billion has been committed to Illinois (including local governments) but \$32 billion has been received by the state at the end of Fiscal Year 2022 (June 30, 2022). More money has been received in FY23 but is not focused on in this analysis. An additional \$8.86 billion was committed straight to local governments. To see a graph of federal funds committed to the State, jump to @sec-covid-money-tracker.

> Update these graphs with new images and new labels... AGH.... I wanna die

![](docs/images/revenues_ioc_32bil.png){#fedrev-iocdata}

Same graph but Switched Fiscal Year and Revenue Category axes:

![](docs/images/revenues_ioc_revsources32.png)

```{r}
sankey_rev_ioc <- read_csv("sankeyattempt2022.csv") %>% 
  filter(StFund == "Total")

sankey_rev_ioc <- sankey_rev_ioc %>% select(Federal, FF_Cat, StateFunds, StFund, Expenditures, value, Notes, Notes2, stfundname) %>%
  filter(StFund == "Total") %>%
  mutate(value=as.numeric(value),
    StateFunds = factor(StateFunds, levels = c("Total_received_fy20","Total_received_fy21", "Total_received_fy22")),
             #     Federal = as.factor(Federal),
               #   Expenditures = factor(Expenditures, levels = c("Transit", "Public Health", "Medicaid", "K-12", "Misc.")),
         Notes2 = factor(Notes2, levels = c("CARES", "Other *", "CRRSA", "ARPA")),
                                 Notes = factor(Notes, levels = c("CARES", "FFCRA", "PPP", "CRRSA", "ARPA")))

ggplot(sankey_rev_ioc, 
       aes(y = value, 
           axis3 = Federal, axis2=FF_Cat, axis1 = StateFunds, label = "stratum")) +
  geom_flow(aes(fill = Notes), color = "black", reverse=FALSE) +
  geom_stratum(reverse=FALSE)+
coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() +
  theme(legend.position = "bottom") + 
      geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE)+
  labs(title = "$32 billion recieved according to IOC Revenue data")


ggplot(sankey_rev_ioc, 
       aes(y = value, 
           axis3 = Federal, axis2 = StateFunds, axis1=FF_Cat, label = "stratum")) +
  geom_flow(aes(fill = Notes), color = "black", reverse=FALSE) +
  geom_stratum(reverse=FALSE)+
coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() +
  theme(legend.position = "bottom", legend.title = element_blank()) + 
      geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE)+
  labs(title = "$32 billion recieved according to IOC Revenue data")
```

```{r include=FALSE}

ggplot(sankey_rev_ioc, 
       aes(y = value, 
           axis3 = Federal, axis2 = StateFunds, axis1=FF_Cat, label = "stratum")) +
  geom_flow(aes(fill = Notes), color = "black", reverse=FALSE) +
  geom_stratum(reverse=FALSE)+
coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() +
  theme(legend.position = "bottom") 
   #   geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE)+
  #ggtitle("$32 billion received according to Illinois Comptroller revenue data")
  
  
  ggplot(sankey_rev_ioc, 
       aes(y = value, axis3 = Federal,  axis2=FF_Cat, axis1 = StateFunds, label = "stratum")) +
  geom_flow(aes(fill = Notes), color = "black", reverse=FALSE) +
 # guides(fill = FALSE) +   
  geom_stratum(reverse=FALSE)+
coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void()+  
    theme(legend.position = "bottom") 
  
  
```

Another way to try to understand the use for the federal funds is to look at what grants were received and what expenditure fiscal category they would be included in.

```{r}
#| code-fold: false
sankey_rev_ioc %>% #group_by(StateFunds) %>% 
  summarize(sum=sum(value))

sankey_rev_ioc %>% group_by(Federal) %>% 
  summarize(sum=sum(value))

sankey_rev_ioc %>% group_by(FF_Cat) %>% 
  summarize(sum=sum(value))

sankey_rev_ioc %>% group_by(StateFunds) %>% 
  summarize(sum=sum(value))

sankey_rev_ioc %>% group_by(Notes) %>% 
  summarize(sum=sum(value))


```

```{r}

sankey_rev_ioc %>% group_by(StateFunds, Expenditures) %>% 
  summarize(sum=sum(value))

sankey_rev_ioc %>% group_by(Expenditures) %>% 
  summarize(sum=sum(value))

sankey_rev_ioc %>% group_by( Notes, Federal, StateFunds, FF_Cat) %>% 
  summarize(sum=sum(value))



ggplot(sankey_rev_ioc, 
       aes(y = value, axis4 = Federal, axis3 = Notes, axis2 = stfundname, axis1=Expenditures, label = "stratum")) +
  geom_flow(aes(fill = Notes), color = "black",reverse=FALSE) +
  guides(fill = FALSE) +   
  geom_stratum(reverse=FALSE)+
coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() +  
  theme(legend.position="bottom") +

  geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE)+
  labs(title = "$32 Billion in Federal Funds Received, Legislation, State Fund 
       that Received Money, and FF Expenditure Category",
       caption = "State CURE funds broken down by expenditure purpose in later graphs.")

ggplot(sankey_rev_ioc, 
       aes(y = value, axis3 = Notes, axis2 = stfundname, axis1=Expenditures, label = "stratum")) +
  geom_flow(aes(fill = Federal), color = "black",reverse=FALSE) +
  guides(fill = FALSE) +   
  geom_stratum(reverse=FALSE)+
coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() +  
  theme(legend.position="bottom") +

  geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE)+
  labs(title = "$32 Billion in Federal Funds Received, Legislation, State Fund 
       that Received Money, and FF Expenditure Category",
       caption = "State CURE funds broken down by expenditure purpose in later graphs.")

```

Highlights legislation, fund money went into, and its intended purpose using Fiscal Futures expenditure categories. The State CURE expenditures are listed as miscellaneous here but are described in more detail farther below.

```{r results='hold'}

# ggplot(sankey, 
#        aes(y = value, axis3 = Notes, axis2 = stfundname, axis1=Expenditures, label = "stratum")) +
#   geom_flow(aes(fill = stfundname), color = "black",reverse=FALSE) +
#   geom_stratum(reverse=FALSE)+
# coord_flip()+
#    scale_fill_brewer(palette = "YlOrRd", direction = -1)+
#   theme_void() +
# theme(legend.position="bottom") +
#   ggtitle("No labels")


ggplot(sankey_rev_ioc, 
       aes(y = value, axis3 = Notes, axis2 = stfundname, axis1=Expenditures, label = "stratum")) +
  geom_flow(aes(fill = stfundname), color = "black", reverse=FALSE) +
  geom_stratum(reverse=FALSE)+
coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() +
  theme(legend.position="bottom") +

      geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2,reverse=FALSE)

```

::: {.callout-important icon="false"}
Medicare includes Healthcare Provider Assistance, reimbursements for the Continuous Coverage Mandate, and reimbursements for the Matching Funds Increase.
:::

These revenue graphs label State CURE as being for miscellaneous purposes due to the difficulty of representing that information broken down cleanly in the graphs. To see how ARPA funds (and State CURE funds in general) were spent, jump to @sec-state-expenditure-graphs.

```{r}
ggplot(sankey_rev_ioc, 
       aes(y = value, 
           axis3 = Notes, axis2 = StateFunds, axis1=Expenditures, label = "stratum")) +
  geom_flow(aes(fill = stfundname), color = "black", reverse=FALSE) +
  geom_stratum(reverse=FALSE)+
coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() +
  theme(legend.position="bottom") +

      geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse = FALSE)

```

> ::: callout-note
> Note: CARES funds were originally received and spent in Disaster Response & Recovery Fund. In FY22, unspent aid was transferred to the State CURE and then transferred again to state agencies for COVID-related expenditures. Remaining CARES funds were transferred to State CURE fund for FY22. \$337 million was also transferred from the Illinois Department of Revenue into the Illinois Housing Development Authority (IHDA). ([LBOC June 2021 Report](https://budget.illinois.gov/content/dam/soi/en/web/budget/documents/lboc/lboc-report-june-2021-final.pdf)).
> :::

Revenue from Local Cure is the Local Government Transfers. A small amount of the State CURE was also transferred to local governments (\$240 million in FY2021). There was also \$700 million ARPA State CURE funds transferred to local governments during FY21 and FY22.

## State Expenditure Graphs {#sec-state-expenditure-graphs}

Federal expenditures from CURE and other major funds . Uses the `fedCUREexpenditures.xlsx` file.

This data comes from Illinois Comptroller expenditure data, Legislative Budget Oversight Commission (LBOC) Reports, and the [ARPA Annual Recovery Plan](https://budget.illinois.gov/content/dam/soi/en/web/budget/documents/arpa/IL%20Recovery%20Plan%20Performance%20Report%202022.pdf) detailing the State's use of State and Local Fiscal Recovery Funds (SLFRF) which is prepared by the Governor's Office of Management and Budget (GOMB).

Dates on top are Fiscal Year received. Dates in the middle of the graph are Fiscal Year expenditures. Remember, federal funds for COVID recovery have been received and spent in different years.

### Fiscal Years 2020-2022

Between FY20 and FY22, \_\_\_\_\_\_\_\_\_(7.628+ESSER) in State CURE and ESSER funds have been spent by the state.

So far, over \$7.629 billion of the State CURE funds (from CARES Act and ARP Act State Fiscal Recovery Fund) have been spent in FY2020-2022. In FY 2021, 3.228 billion CARES dollars were spent.

In FY22, \$4.9 billion (of \$8.127 billion) ARPA-State CURE dollars were spent: \$2.7 billion for repaying unemployment insurance trust fund, \$1 billion transferred to the general revenue fund to make up for any lost revenue caused by the pandemic, and \$1.23 billion on other programs and services (e.g. hospital stability payments, operational expenses, back to business grants and economic development).

Other federal aid came in the form of grants to state departments: ESSER III funds from ARPA paid for \$444 million in K-12 expenditures.

Some CRRSA dollars were also spent in FY22: \$906 million ESSER II and \$332 million from a child care development block grant

In FY21, \$1.82 billion from the CARES-State CURE went to operations and grants for programs and services (e.g. business interruptions, child care grants, healthcare providers, rent/mortgage assistance, public health response, etc.), and \$569 million CARES-ESSER I funds for K-12 education,

Approximately \$1.92 billion of the ESSER funds have been spent so far (of the \$7.88 billion received from ESSER I, II, and III received). In FY 2022 alone, the Illinois School Board for Education received over \$5 billion from ARPA-ESSER III and spent only \$444 million so far. These unspent funds do roll over to the next fiscal year but must be used by 2024. According to the [ISBE Spending Dashboard](https://www.isbe.net/Pages/ESSER-Spending-Dashboard.aspx) as of February 2, 2023, \$1.6 billion of the ESSER III funds have been spent so far.

![](images/image-1332903733.png)

![](images/image-1245655912.png)

```{r}
#| code-fold: false
cure_exp <- read_xlsx("fedCUREexpenditures.xlsx")

cure_exp2022 <- cure_exp %>%
  filter(FY_Spent <2023) %>% # excludes FY23 and beyond
  
  mutate(
         FY_Spent = factor(FY_Spent, levels = c("2020", "2021", "2022")),
         FY_Received = factor(FY_Received, levels = c("2020", "2021", "2022"))#,
      #   FF_Cat = factor(FF_Cat, levels = c("Econ Dev", "Human Services", "K-12", "Local Transfers", "Public Health", "Medicaid", "Public Safety",  "UI Fund", "Lost Revenue")),
     #    FF_Cat2 = factor(FF_Cat, levels = c("Econ Dev", "Human Services", "K-12", "Local Transfers", "Public Health & Safety", "Medicaid",  "UI Fund", "Lost Revenue", "FY23+"))
     )

cure_exp2022 %>% #expenditures per year
  group_by(`FY_Spent`)%>% 
  summarize(Expenditures=sum(`FY Expenditures`))

cure_exp2022 %>% #expenditures per year
  filter(State_local == "State CURE") %>%
  group_by(`FY_Spent`)%>% 
  summarize(Expenditures=sum(`FY Expenditures`))

cure_exp2022 %>% #expenditures for State government (with CURE $) and state departments
  group_by(State_local2)%>% 
  summarize(Expenditures=sum(`FY Expenditures`))

cure_exp2022%>% # total expenditures 
  summarize(Expenditures=sum(`FY Expenditures`)) 

cure_exp2022%>% # total expenditures 
    filter(State_local == "State CURE") %>%
  summarize(Expenditures=sum(`FY Expenditures`)) 


cure_exp2022 %>% 
  group_by(`Federal Funds`)%>% 
  summarize(Expenditures=sum(`FY Expenditures`))


cure_exp2022 %>% 
  group_by(`FF_Cat`)%>% 
  summarize(Expenditures=sum(`FY Expenditures`))

cure_exp2022 %>% 
  group_by(Law)%>% 
  summarize(Expenditures=sum(`FY Expenditures`))


cure_exp2022 %>% 
  group_by(Law, FY_Spent, FF_Cat)%>% 
  summarize(Expenditures=sum(`FY Expenditures`)) %>%
  pivot_wider(names_from = FY_Spent, values_from = Expenditures) 


cure_exp2022 %>% 
  group_by(Law, FY_Received)%>% 
  summarize(Expenditures=sum(`FY Expenditures`)) %>%
  pivot_wider(names_from = Law, values_from = Expenditures) %>% arrange(FY_Received)

cure_exp2022 %>% 
  group_by(Law, FY_Spent)%>% 
  summarize(Expenditures=sum(`FY Expenditures`)) %>%
  pivot_wider(names_from = Law, values_from = Expenditures) %>% 
  arrange(FY_Spent)


```

Tried to add values to flows in graph below. Have not created nice graph that works yet.\\

Code chunk below Includes FY23 and allocations!

```{r}
#| code-fold: false

cure_exp2022 %>% 
  filter(State_local == "State CURE") %>%
  ggplot(aes(y = `FY Expenditures`, axis4 = FY_Received, axis3 = `Agency`,  axis2 = FY_Spent, axis1=FF_Cat, label = "stratum")) +
  geom_flow(aes(fill = FF_Cat), color = "black", reverse=FALSE) +
  geom_stratum(reverse=FALSE)+
  coord_flip()+
  scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() + 
  theme(legend.position="bottom")+
  
  geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE) +
  labs(title = "Expenditures using State CURE funds", subtitle = "Year Received by State Department, Year Spent, and how it was spent so far", caption = "Expenditures occured during FY21 and FY22. 
       Additional funds will continue to be spent in FY23-FY26.")
```

Major uses of the State CURE funds include \$2.7 billion for repaying the unemployment insurance trust fund deficit, \$1 billion was transferred to general revenue to make up for lost revenue during the pandemic, \$2.34 billion has gone towards economic development and recovery, \$1.87 billion to human services, \$1.9 billion to K-12 education.

```{r}


# Year Spent, Agency received, FF Spending Category 
ggplot(cure_exp2022, 
       aes(y = `FY Expenditures`, axis3 = FY_Spent, axis2 = Agency, axis1=FF_Cat, label = "stratum")) +
  geom_flow(aes(fill = Law), color = "black", reverse=FALSE) +
  geom_stratum(reverse=FALSE)+
 #geom_text(stat = "stratum", label.strata = TRUE, reverse=FALSE) + 
  coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
        geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE)+
  theme_void() + 
  theme(legend.position="bottom")+
  ggtitle("CURE & ESSER $12.2 Billion Spent in FY21 & FY22: 
          Year Spent, Agency that Spent it & FF Spending Category")


# Switch Year Spent & Agency received, FF Spending Category 
# ggplot(cure_exp, 
#        aes(y = `FY Expenditures`, axis3 = Agency, axis2 = FY_Spent , axis1=FF_Cat, label = "stratum")) +
#   geom_flow(aes(fill = Law), color = "black", reverse=FALSE) +
#   geom_stratum(reverse=FALSE)+
#  geom_text(stat = "stratum", label.strata = TRUE, reverse=FALSE) + 
#   coord_flip()+
#    scale_fill_brewer(palette = "YlOrRd", direction = -1)+
#         geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE)+
#   theme_void() + 
#     theme(legend.position="bottom")+
# 
#   ggtitle("Same as above but Switched Axis 3 and 2: 
#           Agency received, Year Spent, FF Spending Category ")

# ggplot(cure_exp, 
#        aes(y = `FY Expenditures`, axis3 = `Federal Funds`, axis2 = FY_Spent, axis1=Fund, label = "stratum")) +
#   geom_flow(aes(fill = Law), color = "black", reverse=FALSE) +
#   geom_stratum(reverse=FALSE)+
#  coord_flip()+
#    scale_fill_brewer(palette = "YlOrRd", direction = -1)+
#   theme_void() + 
#         geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE) +
#   theme(legend.position="bottom")+
# 
#   ggtitle("Expenditures: Federal Fund, Year Spent, and State Fund")

cure_exp2022 %>% 
  filter(State_local == "State CURE") %>% 
  ggplot(aes(y = `FY Expenditures`, axis3 = `State_local2`, axis2 = Agency, axis1=FF_Cat, label = "stratum"))+
#ggplot(cure_exp2022, aes(y = `FY Expenditures`, axis3 = `State_local2`, axis2 = Agency, axis1=FF_Cat, label = "stratum")) +
  geom_flow(aes(fill = Law), color = "black", reverse=FALSE) +
  geom_stratum(reverse=FALSE)+
 coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() + 
  theme(legend.position="bottom")+
  geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE) +
  theme(legend.position="bottom")+

  labs(title = "Expenditures: Department that Received Revenue & Purpose of Expenditure", 
       caption = "State CURE, ESSER, and other grants to State Departments")

# ggplot(cure_exp, 
#        aes(y = `Agency_grouped`, axis3 = `State_local2`, axis2 = Agency, axis1=FF_Cat, label = "stratum")) +
#   geom_flow(aes(fill = Law), color = "black", reverse=FALSE) +
#   geom_stratum(reverse=FALSE)+
#  coord_flip()+
#    scale_fill_brewer(palette = "YlOrRd", direction = -1)+
#   theme_void() + 
#   theme(legend.position="bottom")+
#         geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE) +
#   theme(legend.position="bottom")+
# 
#   ggtitle("Same as above but y = Agency Grouped?
#           Expenditures: Department that Received Revenue & How money was used")

# 
# ggplot(cure_exp, 
#        aes(y = `FY Expenditures`, axis3 = `State_local2`, axis2 = FY_Spent, axis1=FF_Cat, label = "stratum")) +
#   geom_flow(aes(fill = Law), color = "black", reverse=FALSE) +
#   geom_stratum(reverse=FALSE)+
#   coord_flip()+
#    scale_fill_brewer(palette = "YlOrRd", direction = -1)+
#   theme_void() + 
#         geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE) +
#   theme(legend.position = "bottom")+
#   ggtitle("Expenditures: Funds from the State of Illinois or State Departments, 
#           Year Spent, and FF Expenditure Purpose")


ggplot(cure_exp2022, 
       aes(y = `FY Expenditures`, axis3 = `State_local2`, axis2 = FY_Spent, axis1=FF_Cat2, label = "stratum")) +
  geom_flow(aes(fill = Law), color = "black", reverse=FALSE) +
  geom_stratum(reverse=FALSE)+
  coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() + 
        geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE) +
  theme(legend.position = "bottom")+
  labs(title = "Expenditures: Funds from the State of Illinois or State Departments, Year Spent, 
          & FF Expenditure Purpose", 
       caption = "Using FF_Cat2 variable with Public Health and Safety Combined")


# ggplot(cure_exp, 
#        aes(y = `FY Expenditures`, axis3 = `State_local2`, axis2 = Fund, axis1=FF_Cat, label = "stratum")) +
#   geom_flow(aes(fill = Law), color = "black", reverse=FALSE) +
#   geom_stratum(reverse=FALSE)+
#   coord_flip()+
#    scale_fill_brewer(palette = "YlOrRd", direction = -1)+
#   theme_void() + 
#         geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE) +
#   theme(legend.position = "bottom")+
#   ggtitle("Expenditures: Funds from the State of Illinois or State Departments, 
#           State Fund Name, and FF Expenditure Category")

```

The graph below shows the year the money was received, the federal fund that it came from, the year that it was spent, and then how the money was used.

```{r}
#4 levels with labels
ggplot(cure_exp2022, 
       aes(y = `FY Expenditures`, axis4 = `FY_Received`,  axis3 = `Federal Funds`, axis2 = FY_Spent, axis1=FF_Cat, label = "stratum")) +
  geom_flow(aes(fill = Law), color = "black", reverse=FALSE) +
  geom_stratum(reverse=FALSE)+
  coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() + 
        geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE) +
    theme(legend.position="bottom")+

  ggtitle("Expenditures So far: Year Received, Federal Fund, Year Spent,
          & How Money was Used")
```

-   \$2.7 Billion spent in FY21 (from CARES)+ \$9.5 billion spent in FY22 (remainder of CARES money, some of ARPA funds).

```{r include=FALSE}

#4 levels, No labels
ggplot(cure_exp2022, 
       aes(y = `FY Expenditures`, axis4 = `FY_Received`,  axis3 = `Federal Funds`, axis2 = FY_Spent, axis1=FF_Cat, label = "stratum")) +
  geom_flow(aes(fill = Law), color = "black", reverse=FALSE) +
  # guides(fill = FALSE) +   
  geom_stratum(reverse=FALSE)+
# geom_text(stat = "stratum", aes(label = after_stat(stratum)), reverse=FALSE) + 
  coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() 
        #geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE) #+ scale_x_discrete(limits = c("FY Received", "", "FY Spent", "") ) + 

  
  
# Bad reject graphs that I won't be using:
ggplot(cure_exp2022, 
       aes(y = `FY Expenditures`,axis3 = `Federal Funds`,axis2 = Agency, axis1=FF_Cat, label = "stratum")) +
  geom_flow(aes(fill = Law), color = "black", reverse=FALSE) +
  geom_stratum(reverse=FALSE)+
  coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() + 
        geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE) 
```

```{r include=FALSE, eval=FALSE}
## Delete this chunk??

sankeydata_spent <- read_csv("sankeyattempt2022.csv") %>% 
  filter(StFund == "Total_spent" | StFund == "Allocated" )%>% 
 # select(Federal, StateFunds, StFund, Expenditures, stfundname, value, Notes) %>%
  mutate(StateFunds = factor(StateFunds, levels = c("Total_received_fy20", "Total_received_fy21", "Total_received_fy22")))
         #Notes = factor(Notes, levels = c(  "CARES", "Other *", "CRRSA", "ARPA")))

ggplot(sankeydata_spent, 
       aes(y = value, axis1 = FF_Cat, axis2=Expenditures, label = "stratum")) +
  geom_flow(aes(fill=FF_Cat),color = "black", reverse=FALSE) +
  # guides(fill = FALSE) +   
  geom_stratum(reverse=FALSE)+
  # geom_text(stat = "stratum", label.strata = TRUE) + 
  coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() +
     scale_x_discrete( limits = c("Federal Funds", "State Funds", "Expenditure Categories") )+ 
      geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 4, reverse=FALSE)+
  labs(title = "Spent")
```

### State CURE Expenditures with FY2023 and beyond allocations

Graphs below include how money has been spent in FY21 and FY22 with unspent funds labeled as `FY2023+`.

This image focuses on only the funds that came through the State and Local Fiscal Recovery Fund and a couple additional funds that came through different agencies but were received by the State of Illinois. Other Federal Revenue largely indicates the ESSER funds that were received by ISBE and were spent on K-12 education.

-   \$3.54 Billion received in FY20 for State Fiscal Recovery Fund (SFRF)+ \$11.8 billion received in FY22 = \$15.3 billion total expenditures and allocations included in this image.

-   Around \$10.8 billion has gone into the State CURE fund (Cornavirus Relief Funds (CRF) and SFRF into the State CURE fund) and another \$4.5 billion was received by State Departments (mostly ISBE for K-12 )

-   So far, over \$13 billion has been spent.

    -   \$2.7 billion was spent in FY21 and \$8.5 Billion was spent in FY22.

    -   The remaining \$2 Billion State CURE funds have been fully allocated and some have been spent already in FY23 (\$500 million transferred to General Revenue for "Lost Revenue" during COVID disruption, remaining dollars on programs and services).

```{r results='hold'}

cure_exp2023 <- cure_exp %>%
  filter(State_local == "State CURE") %>%
  mutate(
         FY_Spent = factor(FY_Spent, levels = c("2020", "2021", "2022", "2023")),
         FY_Received = factor(FY_Received, levels = c("2020", "2021", "2022")),
        FF_Cat = factor(FF_Cat, levels = c("Econ Dev", "Human Services", "K-12", "Local Transfers", "Public Health", "Medicaid", "Public Safety", "Transportation", "UI Fund", "Lost Revenue", "FY23+")),
        FF_Cat2 = factor(FF_Cat2, levels = c("Econ Dev", "Human Services", "K-12", "Local Transfers", "Public Health & Safety", "Medicaid", "Transportation",  "UI Fund", "Lost Revenue", "FY23+"))
      )


cure_exp2023 <- cure_exp2023 %>% 
  group_by(State_local) %>% 
  mutate(pct = `FY Expenditures` / sum(`FY Expenditures`))

cure_exp2023 %>% 
  filter(State_local == "State CURE")%>% summarize(sum=sum(`FY Expenditures`))

cure_exp2023 %>% 
  filter(State_local == "State CURE") %>%
  ggplot(aes(y = pct, 
             axis4 = FY_Received, 
             axis3 = Agency,  
             axis2 = FY_Spent, 
             axis1 = FF_Cat)) +
  geom_flow(aes(fill = Law), color = "black", reverse=FALSE) +
  geom_stratum(reverse=FALSE)+
  scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  coord_flip()+
  theme_void() + 
  theme(legend.position="bottom")+
 # geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE) +
  geom_text(aes(label = paste0(..stratum.., "\n", scales::percent(..count.., accuracy = .1))), stat = "stratum", reverse=FALSE, size=2) +

 # geom_text(stat = "stratum", aes(label = scales::dollar(after_stat(stratum),accuracy =0.01)), size = 2, nudge_x = 0.4) +

  labs(title = "Expenditures using State CURE funds", subtitle = "Year Received by State Department, Year Spent, and how it was spent so far", caption = "Expenditures occured during FY21 and FY22. 
       Additional funds will continue to be spent in FY23-FY26.")

cure_exp2023 %>% 
  filter(State_local == "State CURE") %>%
  ggplot(aes(y = round(`FY Expenditures`, digits=2), 
             axis4 = FY_Received, 
             axis3 = Agency,  
             axis2 = FY_Spent, 
             axis1 = FF_Cat)) +
  geom_flow(aes(fill = Law), color = "black", reverse=FALSE) +
  geom_stratum(reverse=FALSE)+
  scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  coord_flip()+
  theme_void() + 
  theme(legend.position="bottom")+
 geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE) +
#  geom_text(aes(label = paste0(..stratum.., "\n", scales::percent(..count.., accuracy = .1))), stat = "stratum") +

 # geom_text(stat = "stratum", aes(label = scales::dollar(after_stat(stratum),accuracy =0.01)), size = 2, nudge_x = 0.4) +

  labs(title = "Expenditures using State CURE funds", subtitle = "Year Received by State Department, Year Spent, and how it was spent so far", caption = "Expenditures occured during FY21 and FY22. 
       Additional funds will continue to be spent in FY23-FY26.")

#5 levels with labels
ggplot(cure_exp2023, 
       aes(y = `FY Expenditures`,  axis6 = `Federal Funds`, axis5=State_local2, axis4 = `FY_Received`, axis3 = Agency, axis2 = FY_Spent, axis1=FF_Cat2, label = "stratum")) +
  geom_flow(aes(fill = Law), color = "black", reverse=FALSE) +
  geom_stratum(reverse=FALSE)+  coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() + 
  theme(legend.position = "bottom")+
        geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE) + ggtitle("$15.3 Billion in Expenditures and Allocations")

#5 levels with labels


# State CURE funds only
cure_exp2023 %>% filter(State_local2 == "State") %>%
ggplot(aes(y = `FY Expenditures`, axis4 = `FY_Received`,  axis3 = Agency, axis2 = FY_Spent, axis1=FF_Cat2, label = "stratum")) +
  geom_flow(aes(fill = Law), color = "black", reverse=FALSE) +
  geom_stratum(reverse=FALSE)+  coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() + 
  theme(legend.position = "bottom")+
        geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE) + ggtitle("State CURE Only: $10.8 Billion in Expenditures and Allocations")

#4 levels with labels
ggplot(cure_exp2023, 
       aes(y = `FY Expenditures`, axis4 = `FY_Received`,  axis3 = `Federal Funds`, axis2 = FY_Spent, axis1=FF_Cat, label = "stratum")) +
  geom_flow(aes(fill = Law), color = "black", reverse=FALSE) +
  geom_stratum(reverse=FALSE)+
# geom_text(stat = "stratum", aes(label = after_stat(stratum)), reverse=FALSE) + 
  coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() + 
        geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE) + ggtitle("$15.3 Billion in Expenditures and Allocations")


ggplot(cure_exp2023, 
       aes(y = `FY Expenditures`, axis4 = `FY_Received`,  axis3 = `State_local2`, axis2 = FY_Spent, axis1=FF_Cat, label = "stratum")) +
  geom_flow(aes(fill = Law), color = "black", reverse=FALSE) +
  geom_stratum(reverse=FALSE)+
  coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() + 
        geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE) 


ggplot(cure_exp2023, 
       aes(y = `FY Expenditures`, axis3 = `State_local2`, axis2 = FY_Spent, axis1=FF_Cat, label = "stratum")) +
  geom_flow(aes(fill = Law), color = "black", reverse=FALSE) +
  geom_stratum(reverse=FALSE)+
  coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() + 
        geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE)

ggplot(cure_exp2023, 
       aes(y = `FY Expenditures`, axis3 = `State_local2`, axis2 = FY_Spent, axis1=FF_Cat2, label = "stratum")) +
  geom_flow(aes(fill = Law), color = "black", reverse=FALSE) +
  geom_stratum(reverse=FALSE)+
# geom_text(stat = "stratum", aes(label = after_stat(stratum)), reverse=FALSE) + 
  coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() + 
        geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE)



```

```{r}
#| code-fold: false

cure_exp2023 %>% group_by(FY_Received)%>% 
  summarize(Expenditures=sum(`FY Expenditures`))

cure_exp2023 %>% group_by(`Federal Funds`)%>% 
  summarize(Expenditures=sum(`FY Expenditures`))

cure_exp2023 %>% group_by(`FY_Spent`)%>% 
  summarize(Expenditures=sum(`FY Expenditures`))

cure_exp2023 %>% group_by(`FF_Cat`)%>% 
  summarize(Expenditures=sum(`FY Expenditures`))

cure_exp2023 %>% group_by(Law)%>% 
  summarize(Expenditures=sum(`FY Expenditures`))



cure_exp2023 %>% 
  group_by(Law, FY_Received)%>% 
  summarize(Expenditures=sum(`FY Expenditures`)) %>%
  pivot_wider(names_from = Law, values_from = Expenditures) %>% 
  arrange(FY_Received)

cure_exp2023 %>% 
  group_by(Law, FY_Spent)%>% 
  summarize(Expenditures=sum(`FY Expenditures`)) %>%
  pivot_wider(names_from = Law, values_from = Expenditures) %>% 
  arrange(FY_Spent)

cure_exp2023 %>% summarize(Sum=sum(`FY Expenditures`))
```

```{r include=FALSE}
#4 levels, No labels
ggplot(cure_exp2023, 
       aes(y = `FY Expenditures`, axis4 = `FY_Received`,  axis3 = `Federal Funds`, axis2 = FY_Spent, axis1=FF_Cat, label = "stratum")) +
  geom_flow(aes(fill = Law), color = "black", reverse=FALSE) +
  # guides(fill = FALSE) +   
  geom_stratum(reverse=FALSE)+
# geom_text(stat = "stratum", aes(label = after_stat(stratum)), reverse=FALSE) + 
  coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void()# + 
        #geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE)   



```

> Note: Increased Matching Grant and Medicare Continuous Coverage Requirement dollars all count as Federal Medicaid Revenue.

## Revenue & Expenditures Before and During COVID Response

Looking at Federal Revenue received right before and during the pandemic:

All revenue sources within "Federal - Other" source.

```{r}
rev_temp %>% 
  filter(rev_type == "57" & fy >2018) %>% 
  group_by(fund_name, source_name_AWM,  fy) %>% 
  summarize(receipts =sum(receipts)) %>% 
  arrange(fy, -receipts) %>% 
  pivot_wider(names_from = fy, values_from = receipts)

fed_rev_compare <- rev_temp %>% filter((rev_type == "57" | rev_type == "58" | rev_type == "59") & (fy == 2022 | fy==2021 | fy==2020 | fy == 2019)) %>%  arrange(-receipts)

fed_rev_compare


# write_csv(fed_rev_compare, "comparefedrev.csv")


rev_temp %>% filter(source_name_AWM == "FEDERAL STIMULUS PACKAGE") %>% group_by(fy, fund_name) %>% summarize(receipts =sum(receipts)) %>% arrange(-fy)

rev_temp %>% filter(fy > 2018 & source_name_AWM == "FEDERAL STIMULUS PACKAGE") %>% group_by(fund_name, fy) %>% summarize(receipts =sum(receipts)) %>% arrange(-receipts)

rev_temp %>% filter(rev_type == "57" & fy > 2018 & fund_name == "SBE FEDERAL DEPT OF EDUCATION") %>% group_by(source_name_AWM , fund_name, fy) %>% summarize(receipts =sum(receipts)) %>% arrange(-receipts)




```

```{r}
exp_temp <- read_csv("exp_temp.csv")

exp_temp %>% filter(fy >2019 & (fund_name == "STATE CURE" | fund_name == "LOCAL CURE" | fund_name == "SBE FEDERAL DEPT OF EDUCATION" | fund_name == "DISASTER RESPONSE AND RECOVERY" | fund_name == "ESSENTIAL GOVT SERV SUPPORT" )) %>% group_by(fy, agency_name, wh_approp_name, fund_name) %>% 
  summarize(sum=sum(expenditure),
            appropriated = sum(appn_net_xfer)) %>% 
  arrange(-appropriated)

exp_temp %>% filter(fy >2019 & (fund_name == "STATE CURE" | fund_name == "LOCAL CURE" | fund_name == "SBE FEDERAL DEPT OF EDUCATION" | fund_name == "DISASTER RESPONSE AND RECOVERY" | fund_name == "ESSENTIAL GOVT SERV SUPPORT" )) %>% group_by(fy, wh_approp_name, fund_name) %>% 
  summarize(sum=sum(expenditure),
            appropriated = sum(appn_net_xfer)) %>% 
  arrange(-appropriated)

exp_temp %>% filter(fy >2018 & (fund_name == "STATE CURE" | fund_name == "LOCAL CURE" | fund_name == "SBE FEDERAL DEPT OF EDUCATION" | fund_name == "DISASTER RESPONSE AND RECOVERY" | fund_name == "ESSENTIAL GOVT SERV SUPPORT" )) %>% group_by(fy, wh_approp_name, fund_name) %>% 
  summarize(sum=sum(expenditure),
            appropriated = sum(appn_net_xfer)) %>% 
  arrange(-sum)

exp_temp %>% filter(fy >2019 & (fund_name == "STATE CURE" | fund_name == "LOCAL CURE" | fund_name == "SBE FEDERAL DEPT OF EDUCATION" | fund_name == "DISASTER RESPONSE AND RECOVERY" | fund_name == "ESSENTIAL GOVT SERV SUPPORT" )) %>% group_by(fund_name, fy, agency_name) %>% 
  summarize(sum=sum(expenditure),
            appropriated = sum(appn_net_xfer)) %>% 
  arrange(-appropriated)



exp_temp %>% filter(fy == 2022 & (fund_name == "STATE CURE" | fund_name == "LOCAL CURE")) %>% group_by(org_name, agency_name, object, wh_approp_name, fund_name) %>% summarize(sum=sum(expenditure)) %>% arrange(-sum)

exp_temp %>% filter(fy == 2022 & (fund_name == "STATE CURE" | fund_name == "LOCAL CURE")) %>% group_by(agency_name, object, wh_approp_name, fund_name) %>% summarize(sum=sum(expenditure)) %>% arrange(-sum)

exp_temp %>% filter(fy == 2022 & (fund_name == "STATE CURE" | fund_name == "LOCAL CURE")) %>% group_by(fund_name, object, org_name) %>% summarize(sum=sum(expenditure)) %>% arrange(-sum)


exp_temp %>% filter(fy == 2022 & (fund_name == "STATE CURE" | fund_name == "LOCAL CURE")) %>% group_by(fund_name, agency_name) %>% summarize(sum=sum(expenditure)) %>% arrange(-sum)

exp_temp %>% filter(fy == 2022 & (fund_name == "STATE CURE" | fund_name == "LOCAL CURE")) %>% group_by(agency_name) %>% summarize(sum=sum(expenditure)) %>% arrange(-sum)

exp_temp %>% filter(fy == 2021 & (fund_name == "STATE CURE" | fund_name == "LOCAL CURE")) %>% group_by(wh_approp_name, fund_name) %>% summarize(sum=sum(expenditure)) %>% arrange(-sum)
```

## COVID Money Tracker Data - Dollars Committed To Illinois {#sec-covid-money-tracker}

Data was downloaded from COVIDMoneyTracker.org for the State of Illinois. Values reflect the amount committed and not all funds have been disbursed yet. It does not include aid for households or loans to businesses. Data file is named federalcoviddollars.xlsx in Github page used to create this website.

------------------------------------------------------------------------

### Committed Totals - Including Local Governments

The graphs below focus on when the money from each Federal Act arrived and where it was received (local governments, the State government, or directly to a state department) and the spending category that it would be considered using the Fiscal Futures categorization. The State government received \$11.7 billion, state departments received \$31.4 billion, and local governments received \$8.9 billion between FY 2020 and FY 2022. Not all funds have been distributed by the federal government, but they have been committed on the federal level and allocated on the state level.

The \$52 billion total includes Illinois state and local governments (counties, cities, universities, and transit districts) and healthcare providers in the state. Other forms of federal assistance are **not** included in the totals or graphs (i.e. stimulus checks, unemployment insurance assistance for individuals, and the Paycheck Protection Program are excluded from these totals). Summed values from COVIDmoneytracker.org and LBOC December 2022 report match.

Legislation total funds (when including local government aid) were: ARPA = \$25.6 Billion; CARES = \$15.7 Billion; Families First = \$4.5 Billion; PPP & Health Care = \$2.8 Billion; Response & Relief = \$3.4 Billion.

![](images/image-105349095.png)

Local Governments within Illinois received \$8.9 billion for economic recovery but we do not include funds given straight to localities in our State COVID recovery fund calculations or Fiscal Gap analysis.

Additional labels were added using Publisher to create the image above. Preliminary graphs and summed values for the image are calculated in the code chunk below:

```{r}
#| code-fold: false

sankeydata <- read_excel("federalcoviddollars.xlsx")

sankey <- sankeydata %>% 
  #select(Federal, StateFunds, StFund, Expenditures, stfundname, value, Notes) %>%
  #  filter(StFund == "Total") %>%

  mutate(StateFunds = factor(FY, levels = c( "FY20", "FY21", "FY22")),
        Legislation2 = factor(Legislation2, levels = c( "Other", "CARES", "CRRSA", "ARPA")),
                              Legislation1 = factor(Legislation, levels = c( "Families First", "CARES", "PPP & Health Care", "Response & Relief", "ARPA"))
)
         
                 #  Expenditures = factor(Expenditures, levels = c("Community Development", "Public Health", "Medicaid", "K-12", "Federal Other", "Transit")),
      #   Notes = factor(Notes, levels = c(  "CARES", "Other *","CRRSA", "ARPA")))


ggplot(sankey, 
       aes(y = `Dollars Received`, axis3 = FY, axis2 = `Broad Category`, axis1=FF_Cat2, label = "stratum")) +
  geom_flow(aes(fill = Legislation), color = "black", reverse=FALSE) +
 # guides(fill = FALSE) +   
  geom_stratum(reverse=FALSE) +
coord_flip() +
   scale_fill_brewer(palette = "YlOrRd", direction = -1) +
  theme_void() +
     geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE)+
    theme(legend.position = "bottom") +
  labs(title = "$52 Billion in Federal Aid has been Committed to Illinois", subtitle = "State Fiscal Years 2020-2022")


#switches fiscal Year and Broad Category. Not as helpful. 

# ggplot(sankey, 
#        aes(y = `Dollars Received`, axis2 = FY, axis3 = `Broad Category`, axis1=FF_Cat2, label = "stratum")) +
#   geom_flow(aes(fill = Legislation), color = "black", reverse=FALSE) +
#  # guides(fill = FALSE) +   
#   geom_stratum(reverse=FALSE)+
# coord_flip()+
#    scale_fill_brewer(palette = "YlOrRd", direction = -1)+
#   theme_void() +
#      geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE)+
#     theme(legend.position = "bottom")+
#   ggtitle("$52 Million Federal COVID Relief to Illinois over 3 years")


sankey %>% 
  group_by(FY) %>% 
  summarize(sum=sum(`Dollars Received`))

sankey %>% 
  group_by(Legislation) %>% 
  summarize(sum=sum(`Dollars Received`))

sankey %>% 
  group_by(`Broad Category`) %>% 
  summarize(sum=sum(`Dollars Received`))

sankey %>% 
  group_by(Legislation, FF_Cat2) %>% 
  summarize(sum=sum(`Dollars Received`))


sankey %>% 
  group_by(FF_Cat2) %>% 
  summarize(sum=sum(`Dollars Received`))

sankey %>% 
  group_by(Legislation, `Broad Category`,FF_Cat2) %>% 
  summarize(sum=sum(`Dollars Received`))


sankey %>% 
  group_by(FY, FF_Cat2) %>% 
  summarize(sum=sum(`Dollars Received`)) %>% 
  pivot_wider(names_from="FY", values_from = sum)


```

Illinois received \$11.7 billion dollars from State Fiscal Recovery Funds and \$31.4 billion in other federal revenue to state departments. This other federal revenue frequently came in the form of increased or new grants to many State Departments that normally receive federal funding.

```{r include=FALSE}
## Same graph but without labels for Publisher ##

ggplot(sankey, 
       aes(y = `Dollars Received`, axis3 = FY, axis2 = `Broad Category`, axis1=FF_Cat2, label = "stratum")) +
  geom_flow(aes(fill = Legislation), color = "black", reverse=FALSE) +
 # guides(fill = FALSE) +   
  geom_stratum(reverse=FALSE)+
coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() +
   #  geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE)+
    theme(legend.position = "bottom")+
  ggtitle("$52 Million Federal COVID Relief Committed to Illinois over 3 years")
```

```{r include=FALSE}

# another attempt at showing more parts of the data but it is not as useful.
sankey %>% filter(FF_Cat != "Excluded") %>%
ggplot(
       aes(y = `Dollars Received`, axis4 = `Broad Category`, axis3 = Category, axis2 = Recipient, axis1=FF_Cat, label = "stratum")) +
  geom_flow(aes(fill = Legislation), color = "black", reverse=FALSE) +
 # guides(fill = FALSE) +
  geom_stratum(reverse=FALSE)+
coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() +
     geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE)+
    theme(legend.position = "bottom")+
  ggtitle("State CURE and State Departments Received $43.1 Billion")
```

### Committed Totals - Excluding Local Government Funds

Below is a graph showing federal stimulus money that was committed in each year, the federal agency/fund that it came from, and what kind of revenue it was considered (Federal Other, transportation, or medicaid) who received the money (e.g. the State of Illinois, Department of Human Services, Local Governments, etc.). Again, these graphs show the funds that were committed to Illinois and their intended purpose, NOT the data on how or when it was spent.

When Local Funds are included, \$15.7 billion was received in FY20, \$7.24 billion in FY21, and \$29 billion was received in FY22 from multiple COVID response Federal Acts.

Around \$43 billion went to the state and \$8.8 billion went to straight to local governments. When excluding the money that went straight to local governments, the state received \$12.7 billion in FY20 (CARES Act), \$7.24 billion in FY21, and \$23 billion was committed in FY22 (ARP Act). This includes both State CURE funds that had more flexibility in how they were spent as well as the grants and that went to State Departments for specific purposes.

The code below creates same graph as above but funds that went straight to Local Governments (cities and counties) are dropped from the totals.

```{r}
#| code-fold: false

sankey %>% 
  filter(FF_Cat2!= "Excluded") %>%

  ggplot(aes(y = `Dollars Received`, axis3 = FY, axis2 = `Broad Category`, axis1=FF_Cat2, label = "stratum")) +
  geom_flow(aes(fill = Legislation), color = "black", reverse=FALSE) +
 # guides(fill = FALSE) +   
  geom_stratum(reverse=FALSE)+
coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() +
     geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE)+
    theme(legend.position = "bottom")+
  ggtitle("Without Local government relief:
          $12.7 Billion in FY20, $7 Billion in FY21, and $23 Billion in FY22 Committed to Illinois")

sankey %>% filter(FF_Cat2!= "Excluded") %>%
  ggplot(aes(y = `Dollars Received`, axis4 = FY, axis3= `Category`,  axis1=FF_Cat2
          # , label = "stratum"
           )) +
  geom_flow(aes(fill = Legislation, label = "flow"), 
            color = "black", reverse=FALSE) +
 # guides(fill = FALSE) +   
  geom_stratum(reverse=FALSE)+
     geom_text(stat = "stratum", aes(label = after_stat(stratum)), 
               size = 2, reverse=FALSE)+
  coord_flip()+
  scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() +
  theme(legend.position = "bottom")+
  ggtitle("Without Local government relief:
          $12.7 Billion in FY20, $7 Billion in FY21, and $23 Billion in FY22 Committed to Illinois")
```

```{r}
#| code-fold: false

sankey %>% group_by(FY)%>%summarize(TotalReceived=sum(`Dollars Received`))

sankey %>% group_by(Legislation)%>%summarize(TotalReceived=sum(`Dollars Received`))


sankey %>% group_by(Recipient)%>%summarize(TotalReceived=sum(`Dollars Received`))

sankey %>% group_by(FF_Cat)%>%summarize(TotalReceived=sum(`Dollars Received`))

sankey %>% group_by(Legislation, Recipient)%>%summarize(TotalReceived=sum(`Dollars Received`)) %>% pivot_wider(names_from = Legislation, values_from = TotalReceived)

sankey %>% group_by(Legislation, FF_Cat)%>%summarize(TotalReceived=sum(`Dollars Received`)) %>% pivot_wider(names_from = Legislation, values_from = TotalReceived)

sankey %>% group_by(FY, FF_Cat)%>%summarize(TotalReceived=sum(`Dollars Received`)) %>% pivot_wider(names_from = FY, values_from = TotalReceived)

sankey %>% filter(FF_Cat2 != "Excluded") %>% group_by(FY)%>%summarize(TotalReceived=sum(`Dollars Received`))

sankey %>% group_by(Legislation, FF_Cat2)%>%summarize(TotalReceived=sum(`Dollars Received`)) %>% pivot_wider(names_from = Legislation, values_from = TotalReceived)

sankey %>% group_by(FY, FF_Cat2)%>%summarize(TotalReceived=sum(`Dollars Received`)) %>% pivot_wider(names_from = FY, values_from = TotalReceived)

```

```{r results='hold', include=FALSE}
# More graph variations.

data <- read_excel("attemptJan15.xlsx") %>% filter(FF_Cat2 != "Exclude")

ggplot(data, 
       aes(y = Committed, axis4 = FY_Received, axis3 = State_Local, axis2 = StateOrDepartments, axis1=FF_Cat2, label = "stratum")) +
  geom_flow(aes(fill = Law), color = "black", reverse=FALSE) +
 # guides(fill = FALSE) +   
  geom_stratum(reverse=FALSE)+
 # geom_text(stat = "stratum", label.strata = TRUE) + 
coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() +
      geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 4, reverse=FALSE)+
  theme(legend.position = "bottom")+
  ggtitle("$43 Billion for Illinois (Excluding Local CURE funds for Local Governments)")



data %>% filter(FF_Cat2 != "Exclude") %>%
ggplot(aes(y = Committed, axis3 = StateOrDepartments, axis2=FundPurpose2, axis1=FF_Cat, label = "stratum")) +
  geom_flow(aes(fill = Law), color = "black", reverse=FALSE) +
  geom_stratum(reverse=FALSE)+
coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() +
      geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE)+theme(legend.position = "bottom") + 
  ggtitle("Received: $16 Billion for Illinois + $23.3 for State Departments ($39.7 Billion total)")

data %>% filter(FF_Cat2 != "Exclude") %>%
ggplot(aes(y = Committed, axis3 = StateOrDepartments, axis2=`Government Program`, label = "stratum")) +
  geom_flow(aes(fill = Law), color = "black", reverse=FALSE) +
  geom_stratum(reverse=FALSE)+
coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() +
      geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE)+theme(legend.position = "bottom") + 
  ggtitle("Received: $16 Billion for Illinois + $23.3 for State Departments ($39.7 Billion total)")


data %>% group_by(State_Local) %>% summarize(sum=sum(Committed))

data %>% group_by(StateOrDepartments) %>% summarize(sum=sum(Committed))

data %>% group_by(StateOrDepartments, FF_Cat) %>% summarize(sum=sum(Committed))

data %>% group_by(StateOrDepartments, FF_Cat, FY_Received) %>% summarize(sum=sum(Committed)) %>% pivot_wider(names_from = FY_Received, values_from = sum)

data %>% filter(State_Local !="Local") %>% group_by(Law, FF_Cat, FY_Received) %>% summarize(sum=sum(Committed)) %>% pivot_wider(names_from = FY_Received, values_from = sum)

data %>% group_by(StateOrDepartments, FY_Received) %>% summarize(sum=sum(Committed)) %>% pivot_wider(names_from = FY_Received, values_from = sum)

data %>% filter(State_Local !="Local") %>% group_by(Law, FF_Cat) %>% summarize(sum=sum(Committed)) %>% pivot_wider(names_from = Law, values_from = sum)
```

#### Notes on Sankey Graphs

[ggsankey info and example](https://cheatography.com/seleven/cheat-sheets/ggalluvial/)

![](images/image-2109120559.png){width="346"}

A little information on Sankey graphs is below:

-   The axis is how the observations are grouped at each step. There are multiple axes.
-   Strata are the options that exist for each level. (e.g. Year received can be 2021 or 2022)
-   Alluvium correspond to the fixed value of each axis variable. Proportional to how the sum of however you are grouping your data.
-   Flows are the segments of the alluvia between adjacent axes.
