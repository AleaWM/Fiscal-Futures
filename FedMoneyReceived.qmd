# Federal COVID Money Received

```{r warning=FALSE, message=FALSE, echo=FALSE}
knitr::opts_chunk$set(warning=FALSE, message = FALSE)
library(tidyverse)
library(haven)

library(lubridate)
library(smooth)
library(forecast)
library(scales)

library(ggplot2)
library(readxl)
library(tidyverse)
library(data.table)
library(quantmod)
library(geofacet)
library(fredr)
library(sf)
library(usmap)
library(janitor)

library(RColorBrewer)
library(ggsankey)
library(ggalluvial)
library(readxl)
```

Dropping revenue source "Federal Stimulus Package" from the IOC revenue data is one way to start estimating how revenue will look after the COVID relief ends. The graphs below show Illinois revenue with and without Federal Stimulus Package revenue. It is important to note that only the \$8.127 ARPA State CURE and \$3.519 CARES CRF/State CURE revenue were labeled as "Federal Stimulus Package" in the IOC revenue data. There was still an additional \$12 billion dollars in other federal revenue that went to the state in FY22 compared to FY19. When trying to understand the states finances and the yearly fiscal gap, we also need to understand when and where the funds were considered revenue in the IOC data and consider the fiscal year that the funds were spent. Finally, allocations or expenditures may be grouped and labeled differently by the State compared to the Fiscal Futures project categorization. Some items that the federal relief are spent on are not included in Fiscal Gap calculations (e.g. the Unemployment Insurance Trust Fund repayments). The biggest challenge when determining the Fiscal Gap for Illinois centers around the timing of revenue and expenditures occurring in different fiscal years during the COVID response.

```{r results='hold'}

rev_temp <- read_csv("rev_temp.csv")

fedrev<- rev_temp %>% 
  filter(rev_type == "58" | rev_type == "59" | rev_type == "57") 

fedrev %>% filter(fy>2018) %>% group_by(fy) %>% summarize(Revenue = sum(receipts))

fedrev %>% 
  filter(source_name_AWM == "FEDERAL STIMULUS PACKAGE" & fy>2018) %>%
  group_by(fy) %>% 
  summarise(receipts = sum(receipts, na.rm = TRUE)/1000000)

fedrev %>% 
  filter(fy>2018) %>%
  group_by(fy, fund_name) %>% 
  summarise(receipts = sum(receipts, na.rm = TRUE)/1000000) %>%
  arrange(-receipts) %>%
  pivot_wider(names_from = fy, values_from = receipts)

fedrev %>% 
  group_by(fy) %>% 
  summarise(receipts = sum(receipts, na.rm = TRUE)/1000000) %>% 
  ggplot() +
  geom_line(aes(x=fy, y=receipts)) +
      theme_bw() +
  scale_y_continuous(labels = comma)+
  labs(title = "All Federal Revenue", 
       y = "Millions of Dollars", x = "") + 
  theme(legend.position = "bottom", legend.title = element_blank()  )+
    scale_y_continuous(limits = c(0,45000))


fedrev %>% 
  filter(source_name_AWM != "FEDERAL STIMULUS PACKAGE" ) %>%
  group_by(fy) %>% 
  summarise(receipts = sum(receipts, na.rm = TRUE)/1000000) %>% 
  ggplot() +
  geom_line(aes(x=fy, y=receipts)) +
      theme_bw() +
  scale_y_continuous(labels = comma)+
  labs(title = "All Federal EXCEPT Federal Stimulus Package", 
       y = "Millions of Dollars", x = "",
       caption = "Note: Dropping Federal Stimulus Package revenue only removes the $3.5 billion from FY20, 
       $0.3 billion from FY21, and $8.5 billion from FY22. Also drops Great Recession Aid in 2009.
       There is still over $12 billion more in Federal Revenue compared to FY19.") + 
  theme(legend.position = "bottom", legend.title = element_blank()  ) +
  scale_y_continuous(limits = c(0,45000))



```

## COVID Money Tracker Data

Data was downloaded from COVIDMoneyTracker.org for the State of Illinois. Values reflect the amount committed and not all funds have been disbursed yet. It does not include aid for households or loans to businesses. Data file is named federalcoviddollars.xlsx in Github page used to create this website.

A little information on Sankey graphs is below:

-   The axis is how the observations are grouped at each step. There are multiple axes.
-   Strata are the options that exist for each level. (e.g. Year received can be 2021 or 2022)
-   Alluvium correspond to the fixed value of each axis variable. Proportional to how the sum of however you are grouping your data.
-   Flows are the segments of the alluvia between adjacent axes.

Read the charts from the top to the bottom. Most of the graphs below begin with either the year the money was committed or the name of the Law that provided the funds and then shows it flowing down to either who received the money or how it was spent.

The graphs below focus on when the money from each Federal Act arrived and where it was received (local governments, the State government, or directly to a state department) and the spending category that it would be considered using the Fiscal Futures categorization. The State government received \$11.7 billion, state departments received \$31.4 billion, and local governments received \$8.9 billion between FY 2020 and FY 2022. Not all funds have been distributed by the federal government, but they have been committed on the federal level and allocated on the state level.

```{r results='hold'}
sankeydata <- read_excel("federalcoviddollars.xlsx")
sankey <- sankeydata %>% 
  #select(Federal, StateFunds, StFund, Expenditures, stfundname, value, Notes) %>%
  #  filter(StFund == "Total") %>%

  mutate(StateFunds = factor(FY, levels = c( "FY20", "FY21", "FY22")),
        Legislation2 = factor(Legislation2, levels = c( "Other", "CARES", "CRRSA", "ARPA")),
                              Legislation1 = factor(Legislation, levels = c( "Families First", "CARES", "PPP & Health Care", "Response & Relief", "ARPA"))
)
         
                 #  Expenditures = factor(Expenditures, levels = c("Community Development", "Public Health", "Medicaid", "K-12", "Federal Other", "Transit")),
      #   Notes = factor(Notes, levels = c(  "CARES", "Other *","CRRSA", "ARPA")))


ggplot(sankey, 
       aes(y = `Dollars Received`, axis3 = FY, axis2 = `Broad Category`, axis1=FF_Cat2, label = "stratum")) +
  geom_flow(aes(fill = Legislation), color = "black", reverse=FALSE) +
 # guides(fill = FALSE) +   
  geom_stratum(reverse=FALSE)+
coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() +
     geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE)+
    theme(legend.position = "bottom")+
  ggtitle("$52 Million Federal COVID Relief to Illinois over 3 years")


#switches fiscal Year and Broad Category. Not as helpful. 

# ggplot(sankey, 
#        aes(y = `Dollars Received`, axis2 = FY, axis3 = `Broad Category`, axis1=FF_Cat2, label = "stratum")) +
#   geom_flow(aes(fill = Legislation), color = "black", reverse=FALSE) +
#  # guides(fill = FALSE) +   
#   geom_stratum(reverse=FALSE)+
# coord_flip()+
#    scale_fill_brewer(palette = "YlOrRd", direction = -1)+
#   theme_void() +
#      geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE)+
#     theme(legend.position = "bottom")+
#   ggtitle("$52 Million Federal COVID Relief to Illinois over 3 years")


sankey %>% group_by(FY) %>% summarize(sum=sum(`Dollars Received`))
sankey %>% group_by(Legislation) %>% summarize(sum=sum(`Dollars Received`))

sankey %>% group_by(`Broad Category`) %>% summarize(sum=sum(`Dollars Received`))
sankey %>% group_by(Legislation, FF_Cat2) %>% summarize(sum=sum(`Dollars Received`))


sankey %>% group_by(FF_Cat2) %>% summarize(sum=sum(`Dollars Received`))

sankey %>% group_by(Legislation, `Broad Category`,FF_Cat2) %>% summarize(sum=sum(`Dollars Received`))


sankey %>% group_by(FY, FF_Cat2) %>% summarize(sum=sum(`Dollars Received`)) %>% pivot_wider(names_from="FY", values_from = sum)


```

```{r include=FALSE}
## Same graph but without labels for Publisher ##

ggplot(sankey, 
       aes(y = `Dollars Received`, axis3 = FY, axis2 = `Broad Category`, axis1=FF_Cat2, label = "stratum")) +
  geom_flow(aes(fill = Legislation), color = "black", reverse=FALSE) +
 # guides(fill = FALSE) +   
  geom_stratum(reverse=FALSE)+
coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() +
   #  geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE)+
    theme(legend.position = "bottom")+
  ggtitle("$52 Million Federal COVID Relief to Illinois over 3 years")
```

Legislation values were: ARPA = \$25.6 Billion; CARES = \$15.7 Billion; Families First = \$4.5 Billion; PPP & Health Care = \$2.8 Billion; Response & Relief = \$3.4 Billion. Additional labels were added using Publisher to create the following image:

![](images/image-105349095.png)

Illinois received \$11.7 billion dollars from State Fiscal Recovery Funds and \$31.4 billion in other federal revenue to state departments. This other federal revenue frequently came in the form of increased or new grants to many State Departments that normally receive federal funding. Local Governments within Illinois received an additional \$8.9 billion for economic recovery but we do not include funds given straight to localities in our State COVID recovery fund calculations or Fiscal Gap analysis.

```{r include=FALSE}

# another attempt at showing more parts of the data but it is not as useful.
sankey %>% filter(FF_Cat != "Excluded") %>%
ggplot(
       aes(y = `Dollars Received`, axis4 = `Broad Category`, axis3 = Category, axis2 = Recipient, axis1=FF_Cat, label = "stratum")) +
  geom_flow(aes(fill = Legislation), color = "black", reverse=FALSE) +
 # guides(fill = FALSE) +
  geom_stratum(reverse=FALSE)+
coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() +
     geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE)+
    theme(legend.position = "bottom")+
  ggtitle("State CURE and State Departments Received $43.1 Billion")
```

Below is a graph showing federal stimulus money that was received in each year, the federal agency/fund that it came from, and what kind of revenue it was considered (Federal Other, transportation, or medicaid) who received the money (e.g. the State of Illinois, Department of Human Services, Local Governments, etc.). \$15.7 billion was received in FY20, \$7.24 billion in FY21, and \$29 billion was received in FY22 from multiple COVID response Federal Acts. The graph above shows the year received, the federal government's fund name or purpose, the department that received the funds, and the fiscal futures spending category that the purpose falls under.

Again, these graphs show the funds that were received and their intended purpose, NOT the data on how or when it was spent.

```{r}
sankey %>% filter(FF_Cat2!= "Excluded") %>%
  ggplot(aes(y = `Dollars Received`, axis4 = FY, axis3= `Category`,  axis1=FF_Cat2
          # , label = "stratum"
           )) +
  geom_flow(aes(fill = Legislation, label = "flow"), 
            color = "black", reverse=FALSE) +
 # guides(fill = FALSE) +   
  geom_stratum(reverse=FALSE)+
     geom_text(stat = "stratum", aes(label = after_stat(stratum)), 
               size = 2, reverse=FALSE)+
  coord_flip()+
  scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() +
  theme(legend.position = "bottom")+
  ggtitle("State Received $16 Billion in FY20, $7 Billion in FY21, and $29 Billion in FY22")
```

```{r results='hold'}

sankey %>% group_by(FY)%>%summarize(TotalReceived=sum(`Dollars Received`))

sankey %>% group_by(Legislation)%>%summarize(TotalReceived=sum(`Dollars Received`))


sankey %>% group_by(Recipient)%>%summarize(TotalReceived=sum(`Dollars Received`))

sankey %>% group_by(FF_Cat)%>%summarize(TotalReceived=sum(`Dollars Received`))

sankey %>% group_by(Legislation, Recipient)%>%summarize(TotalReceived=sum(`Dollars Received`)) %>% pivot_wider(names_from = Legislation, values_from = TotalReceived)

sankey %>% group_by(Legislation, FF_Cat)%>%summarize(TotalReceived=sum(`Dollars Received`)) %>% pivot_wider(names_from = Legislation, values_from = TotalReceived)

sankey %>% group_by(FY, FF_Cat)%>%summarize(TotalReceived=sum(`Dollars Received`)) %>% pivot_wider(names_from = FY, values_from = TotalReceived)


sankey %>% group_by(Legislation, FF_Cat2)%>%summarize(TotalReceived=sum(`Dollars Received`)) %>% pivot_wider(names_from = Legislation, values_from = TotalReceived)

sankey %>% group_by(FY, FF_Cat2)%>%summarize(TotalReceived=sum(`Dollars Received`)) %>% pivot_wider(names_from = FY, values_from = TotalReceived)

```

```{r results='hold', include=FALSE}
# More graph variations.

data <- read_excel("attemptJan15.xlsx") %>% filter(FF_Cat2 != "Exclude")

ggplot(data, 
       aes(y = Committed, axis4 = FY_Received, axis3 = State_Local, axis2 = StateOrDepartments, axis1=FF_Cat2, label = "stratum")) +
  geom_flow(aes(fill = Law), color = "black", reverse=FALSE) +
 # guides(fill = FALSE) +   
  geom_stratum(reverse=FALSE)+
 # geom_text(stat = "stratum", label.strata = TRUE) + 
coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() +
      geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 4, reverse=FALSE)+
  theme(legend.position = "bottom")+
  ggtitle("$43 Billion for Illinois (Excluding Local CURE funds for Local Governments)")



data %>% filter(FF_Cat2 != "Exclude") %>%
ggplot(aes(y = Committed, axis3 = StateOrDepartments, axis2=FundPurpose2, axis1=FF_Cat, label = "stratum")) +
  geom_flow(aes(fill = Law), color = "black", reverse=FALSE) +
  geom_stratum(reverse=FALSE)+
coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() +
      geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE)+theme(legend.position = "bottom") + 
  ggtitle("Received: $16 Billion for Illinois + $23.3 for State Departments ($39.7 Billion total)")

data %>% filter(FF_Cat2 != "Exclude") %>%
ggplot(aes(y = Committed, axis3 = StateOrDepartments, axis2=`Government Program`, label = "stratum")) +
  geom_flow(aes(fill = Law), color = "black", reverse=FALSE) +
  geom_stratum(reverse=FALSE)+
coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() +
      geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE)+theme(legend.position = "bottom") + 
  ggtitle("Received: $16 Billion for Illinois + $23.3 for State Departments ($39.7 Billion total)")


data %>% group_by(State_Local) %>% summarize(sum=sum(Committed))

data %>% group_by(StateOrDepartments) %>% summarize(sum=sum(Committed))

data %>% group_by(StateOrDepartments, FF_Cat) %>% summarize(sum=sum(Committed))

data %>% group_by(StateOrDepartments, FF_Cat, FY_Received) %>% summarize(sum=sum(Committed)) %>% pivot_wider(names_from = FY_Received, values_from = sum)

data %>% filter(State_Local !="Local") %>% group_by(Law, FF_Cat, FY_Received) %>% summarize(sum=sum(Committed)) %>% pivot_wider(names_from = FY_Received, values_from = sum)

data %>% group_by(StateOrDepartments, FY_Received) %>% summarize(sum=sum(Committed)) %>% pivot_wider(names_from = FY_Received, values_from = sum)

data %>% filter(State_Local !="Local") %>% group_by(Law, FF_Cat) %>% summarize(sum=sum(Committed)) %>% pivot_wider(names_from = Law, values_from = sum)
```

## Expenditures Graphs

Federal expenditures from CURE and other major funds . Uses the `fedCUREexpenditures.xlsx` file.

This data comes from Illinois Comptroller expenditure data, Legislative Budget Oversight Commission (LBOC) Reports, and the [ARPA Annual Recovery Plan](https://budget.illinois.gov/content/dam/soi/en/web/budget/documents/arpa/IL%20Recovery%20Plan%20Performance%20Report%202022.pdf) detailing the State's use of State and Local Fiscal Recovery Funds (SLFRF) which is prepared by the Governor's Office of Management and Budget (GOMB).

The graphs below do not include FY23 allocations for federal funds. Dates on top are Fiscal Year received. Dates in the middle of the graph are Fiscal Year expenditures. Federal funds for COVID recovery have been received and spent in different years. This makes calculating and comparing the fiscal gap difficult.

```{r results='hold'}

cure_exp <- read_xlsx("fedCUREexpenditures.xlsx")

cure_exp <- cure_exp %>%
   filter(FY_Spent <2023) %>%

  mutate(
         FY_Spent = factor(FY_Spent, levels = c("2020", "2021", "2022", "2023+")),
         FY_Received = factor(FY_Received, levels = c("2020", "2021", "2022")),
         FF_Cat = factor(FF_Cat, levels = c("Econ Dev", "Human Services", "K-12", "Local Transfers", "Public Health", "Medicaid", "Public Safety", "Lost Revenue", "UI Fund", "FY23+"))
         )

cure_exp %>% group_by(FY_Received)%>% summarize(Expenditures=sum(`FY Expenditures`))

cure_exp %>% group_by(`Federal Funds`)%>% summarize(Expenditures=sum(`FY Expenditures`))

cure_exp %>% group_by(State_local2)%>% summarize(Expenditures=sum(`FY Expenditures`))


cure_exp%>% summarize(Expenditures=sum(`FY Expenditures`))
cure_exp %>% group_by(`FY_Spent`)%>% summarize(Expenditures=sum(`FY Expenditures`))

cure_exp %>% group_by(`FF_Cat`)%>% summarize(Expenditures=sum(`FY Expenditures`))

cure_exp %>% group_by(Law)%>% summarize(Expenditures=sum(`FY Expenditures`))


cure_exp %>% group_by(Law, FY_Spent, FF_Cat)%>% summarize(Expenditures=sum(`FY Expenditures`)) %>%
  pivot_wider(names_from = FY_Spent, values_from = Expenditures) 


cure_exp %>% group_by(Law, FY_Received)%>% summarize(Expenditures=sum(`FY Expenditures`)) %>%
  pivot_wider(names_from = Law, values_from = Expenditures) %>% arrange(FY_Received)

cure_exp %>% group_by(Law, FY_Spent)%>% summarize(Expenditures=sum(`FY Expenditures`)) %>%
  pivot_wider(names_from = Law, values_from = Expenditures) %>% arrange(FY_Spent)


```

```{r results='hold'}

# Year Spent, Agency received, FF Spending Category 
ggplot(cure_exp, 
       aes(y = `FY Expenditures`, axis3 = FY_Spent, axis2 = Agency, axis1=FF_Cat, label = "stratum")) +
  geom_flow(aes(fill = Law), color = "black", reverse=FALSE) +
  geom_stratum(reverse=FALSE)+
 geom_text(stat = "stratum", label.strata = TRUE, reverse=FALSE) + 
  coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
        geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE)+
  theme_void() + 
  theme(legend.position="bottom")+
  ggtitle("CURE & ESSER
          $12.2 Billion Spent So far: Year Spent, Agency received, FF Spending Category")


# Switch Year Spent & Agency received, FF Spending Category 
ggplot(cure_exp, 
       aes(y = `FY Expenditures`, axis3 = Agency, axis2 = FY_Spent , axis1=FF_Cat, label = "stratum")) +
  geom_flow(aes(fill = Law), color = "black", reverse=FALSE) +
  geom_stratum(reverse=FALSE)+
 geom_text(stat = "stratum", label.strata = TRUE, reverse=FALSE) + 
  coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
        geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE)+
  theme_void() + 
    theme(legend.position="bottom")+

  ggtitle("Expenditures: Agency received, Year Spent, FF Spending Category ")

ggplot(cure_exp, 
       aes(y = `FY Expenditures`, axis3 = `Federal Funds`, axis2 = FY_Spent, axis1=Fund, label = "stratum")) +
  geom_flow(aes(fill = Law), color = "black", reverse=FALSE) +
  geom_stratum(reverse=FALSE)+
 coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() + 
        geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE) +
  theme(legend.position="bottom")+

  ggtitle("Expenditures: Department that Received Revenue, Year Spent, and Purpose of Expenditure")

ggplot(cure_exp, 
       aes(y = `FY Expenditures`, axis3 = `State_local2`, axis2 = Agency, axis1=FF_Cat, label = "stratum")) +
  geom_flow(aes(fill = Law), color = "black", reverse=FALSE) +
  geom_stratum(reverse=FALSE)+
 coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() + 
  theme(legend.position="bottom")+
        geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE) +
  theme(legend.position="bottom")+

  ggtitle("Expenditures: Department that Received Revenue, Year Spent, and Purpose of Expenditure")

ggplot(cure_exp, 
       aes(y = `Agency_grouped`, axis3 = `State_local2`, axis2 = Agency, axis1=FF_Cat, label = "stratum")) +
  geom_flow(aes(fill = Law), color = "black", reverse=FALSE) +
  geom_stratum(reverse=FALSE)+
 coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() + 
  theme(legend.position="bottom")+
        geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE) +
  theme(legend.position="bottom")+

  ggtitle("Expenditures: Department that Received Revenue, Year Spent, and Purpose of Expenditure")


ggplot(cure_exp, 
       aes(y = `FY Expenditures`, axis3 = `State_local2`, axis2 = FY_Spent, axis1=FF_Cat, label = "stratum")) +
  geom_flow(aes(fill = Law), color = "black", reverse=FALSE) +
  geom_stratum(reverse=FALSE)+
  coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() + 
        geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE) +
  theme(legend.position = "bottom")+
  ggtitle("Expenditures: Funds from the State of Illinois or State Departments, Year Spent, and FF Expenditure Purpose")

ggplot(cure_exp, 
       aes(y = `FY Expenditures`, axis3 = `State_local2`, axis2 = Fund, axis1=FF_Cat, label = "stratum")) +
  geom_flow(aes(fill = Law), color = "black", reverse=FALSE) +
  geom_stratum(reverse=FALSE)+
  coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() + 
        geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE) +
  theme(legend.position = "bottom")+
  ggtitle("Expenditures: Funds from the State of Illinois or State Departments, Year Spent, and FF Expenditure Purpose")

ggplot(cure_exp, 
       aes(y = `FY Expenditures`, axis3 = `State_local2`, axis2 = FY_Spent, axis1=FF_Cat2, label = "stratum")) +
  geom_flow(aes(fill = Law), color = "black", reverse=FALSE) +
  geom_stratum(reverse=FALSE)+
  coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() + 
        geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE) +
  theme(legend.position = "bottom")+
  ggtitle("Expenditures: Funds from the State of Illinois or State Departments, Year Spent, and FF Expenditure Purpose")

#4 levels with labels
ggplot(cure_exp, 
       aes(y = `FY Expenditures`, axis4 = `FY_Received`,  axis3 = `Federal Funds`, axis2 = FY_Spent, axis1=FF_Cat, label = "stratum")) +
  geom_flow(aes(fill = Law), color = "black", reverse=FALSE) +
  geom_stratum(reverse=FALSE)+
  coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() + 
        geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE) +
    theme(legend.position="bottom")+

  ggtitle("Year Received, Federal Fund, Year Spent, and Purpose")


cure_exp %>% filter(State_local == "State CURE") %>%
ggplot(aes(y = `FY Expenditures`, axis4 = FY_Received, axis3 = `Agency`,  axis2 = FY_Spent, axis1=FF_Cat, label = "stratum")) +
  geom_flow(aes(fill = Law), color = "black", reverse=FALSE) +
  geom_stratum(reverse=FALSE)+
  coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() + 
    theme(legend.position="bottom")+

        geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE) +
  ggtitle("Year Received, Federal Fund, Year Spent, and Purpose")





```

```{r include=FALSE}

#4 levels, No labels
ggplot(cure_exp, 
       aes(y = `FY Expenditures`, axis4 = `FY_Received`,  axis3 = `Federal Funds`, axis2 = FY_Spent, axis1=FF_Cat, label = "stratum")) +
  geom_flow(aes(fill = Law), color = "black", reverse=FALSE) +
  # guides(fill = FALSE) +   
  geom_stratum(reverse=FALSE)+
# geom_text(stat = "stratum", aes(label = after_stat(stratum)), reverse=FALSE) + 
  coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() 
        #geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE) #+ scale_x_discrete(limits = c("FY Received", "", "FY Spent", "") ) + 

  
  
# Bad reject graphs that I won't be using:
ggplot(cure_exp, 
       aes(y = `FY Expenditures`,axis3 = `Federal Funds`,axis2 = Agency, axis1=FF_Cat, label = "stratum")) +
  geom_flow(aes(fill = Law), color = "black", reverse=FALSE) +
  geom_stratum(reverse=FALSE)+
  coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() + 
        geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE) 
```

Graphs below include how money has been spent in FY21 and FY22 with unspent funds labeled as `FY2023+`.

This image focuses on only the funds that came through the State and Local Fiscal Recovery Fund and a couple additional funds that came through different agencies but were received by the State of Illinois. Other Federal Revenue largely indicates the ESSER funds that were received by ISBE and were spent on K-12 education.

```{r results='hold'}
cure_exp <- read_xlsx("fedCUREexpenditures.xlsx")

cure_exp <- cure_exp %>%
 #   filter(FY_Spent <2023) %>%

  mutate(
         FY_Spent = factor(FY_Spent, levels = c("2020", "2021", "2022", "2023+")),
         FY_Received = factor(FY_Received, levels = c("2020", "2021", "2022")),
         FF_Cat = factor(FF_Cat, levels = c("Econ Dev", "Human Services", "K-12", "Local Transfers", "Public Health", "Medicaid", "Public Safety", "UI Fund", "Lost Revenue", "FY23+"))
        
         )



#4 levels with labels
ggplot(cure_exp, 
       aes(y = `FY Expenditures`, axis4 = `FY_Received`,  axis3 = `Federal Funds`, axis2 = FY_Spent, axis1=FF_Cat, label = "stratum")) +
  geom_flow(aes(fill = Law), color = "black", reverse=FALSE) +
  geom_stratum(reverse=FALSE)+
# geom_text(stat = "stratum", aes(label = after_stat(stratum)), reverse=FALSE) + 
  coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() + 
        geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE) 


ggplot(cure_exp, 
       aes(y = `FY Expenditures`, axis4 = `FY_Received`,  axis3 = `State_local2`, axis2 = FY_Spent, axis1=FF_Cat, label = "stratum")) +
  geom_flow(aes(fill = Law), color = "black", reverse=FALSE) +
  geom_stratum(reverse=FALSE)+
# geom_text(stat = "stratum", aes(label = after_stat(stratum)), reverse=FALSE) + 
  coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() + 
        geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE) 

ggplot(cure_exp, 
       aes(y = `FY Expenditures`, axis3 = `State_local2`, axis2 = FY_Spent, axis1=FF_Cat, label = "stratum")) +
  geom_flow(aes(fill = Law), color = "black", reverse=FALSE) +
  geom_stratum(reverse=FALSE)+
# geom_text(stat = "stratum", aes(label = after_stat(stratum)), reverse=FALSE) + 
  coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() + 
        geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE)

ggplot(cure_exp, 
       aes(y = `FY Expenditures`, axis3 = `State_local2`, axis2 = FY_Spent, axis1=FF_Cat2, label = "stratum")) +
  geom_flow(aes(fill = Law), color = "black", reverse=FALSE) +
  geom_stratum(reverse=FALSE)+
# geom_text(stat = "stratum", aes(label = after_stat(stratum)), reverse=FALSE) + 
  coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() + 
        geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE)



cure_exp %>% group_by(FY_Received)%>% summarize(Expenditures=sum(`FY Expenditures`))

cure_exp %>% group_by(`Federal Funds`)%>% summarize(Expenditures=sum(`FY Expenditures`))

cure_exp %>% group_by(`FY_Spent`)%>% summarize(Expenditures=sum(`FY Expenditures`))

cure_exp %>% group_by(`FF_Cat`)%>% summarize(Expenditures=sum(`FY Expenditures`))

cure_exp %>% group_by(Law)%>% summarize(Expenditures=sum(`FY Expenditures`))



cure_exp %>% group_by(Law, FY_Received)%>% summarize(Expenditures=sum(`FY Expenditures`)) %>%
  pivot_wider(names_from = Law, values_from = Expenditures) %>% arrange(FY_Received)

cure_exp %>% group_by(Law, FY_Spent)%>% summarize(Expenditures=sum(`FY Expenditures`)) %>%
  pivot_wider(names_from = Law, values_from = Expenditures) %>% arrange(FY_Spent)
```

\$3.5 Billion received in FY20 for SFRF, \$9.7 billion received in FY22. Over \$10 billion has gone into the State CURE fund and another \$2.4 billion was received by State Departments. Of that over \$13 billion spent, \$2.7 billion was spent in FY21 and \$8.5 Billion was spent in FY22. The remaining \$2 Billion State CURE funds have been fully allocated and some have been spent already in FY23 (\$500 million on lost revenue, remaining on programs and services).

```{r include=FALSE}
#4 levels, No labels
ggplot(cure_exp, 
       aes(y = `FY Expenditures`, axis4 = `FY_Received`,  axis3 = `Federal Funds`, axis2 = FY_Spent, axis1=FF_Cat, label = "stratum")) +
  geom_flow(aes(fill = Law), color = "black", reverse=FALSE) +
  # guides(fill = FALSE) +   
  geom_stratum(reverse=FALSE)+
# geom_text(stat = "stratum", aes(label = after_stat(stratum)), reverse=FALSE) + 
  coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void()# + 
        #geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE) #+ scale_x_discrete(limits = c("FY Received", "", "FY Spent", "") )  



```

> Note: Increased Matching Grant and Medicare Continuous Coverage Requirement dollars all count as Federal Medicaid Revenue. TANF and SNAP are considered Other Federal Revenue.

## Other Revenue Graphs

Sankeyattempt2022.csv file totals \$32 billion flowing into the state. \$3.5 came in FY20, \$12 billion came in FY21 and \$16.1 billion in FY22.

```{r results='hold' }
sankeydata <- read_csv("sankeyattempt2022.csv") %>% filter(StFund == "Total")

sankeydata2 <- sankeydata %>% select(Federal, StateFunds, StFund, Expenditures, value, Notes) %>%
  filter(StFund == "Total") %>%
  mutate(StateFunds = factor(StateFunds, levels = c("Total_received_fy20","Total_received_fy21", "Total_received_fy22")),
                  Federal = as.factor(Federal),
                  Expenditures = factor(Expenditures, levels = c("Community Development", "Transit", "Public Health", "Medicaid", "K-12", "Federal Other")),
         Notes = factor(Notes, levels = c("CARES", "CRRSA", "ARPA", "Other *")))

sankey4 <- sankeydata2

ggplot(sankey4, 
       aes(y = value, 
           axis3 = Federal, axis2 = StateFunds, axis1=Expenditures, label = "stratum")) +
  geom_flow(aes(fill = Notes), color = "black", reverse=FALSE) +
  geom_stratum(reverse=FALSE)+
coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() +
     scale_x_discrete( limits = c("Federal Funds", "State Funds", "Expenditure Categories") )+ 
      geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE)
```

```{r include=FALSE}
ggplot(sankey4, 
       aes(y = value, axis3 = Federal, axis2 = StateFunds, axis1=Expenditures, label = "stratum")) +
  geom_flow(aes(fill = Notes), color = "black", reverse=FALSE) +
 # guides(fill = FALSE) +   
  geom_stratum(reverse=FALSE)+
 # geom_text(stat = "stratum", label.strata = TRUE) + 
coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void()
  #    geom_text_repel(stat = "stratum", aes(label = after_stat(stratum)), size = 4)
  ggtitle("")
  
  
  
  
# sankey4 <- sankeydata %>% select(Federal, StateFunds, StFund, Expenditures, value, Notes) %>%
#   filter(StFund == "Total") %>%
#   mutate(StateFunds = factor(StateFunds, levels = c("Total_received_fy21", "Total_received_fy22")),
#                   Federal = as.factor(Federal),
#                   Expenditures = as.factor(Expenditures) )
```

```{r results='hold'}
sankey4 %>% #group_by(StateFunds) %>% 
  summarize(sum=sum(value))

sankey4 %>% group_by(StateFunds) %>% 
  summarize(sum=sum(value))

sankey4 %>% group_by(Expenditures) %>% 
  summarize(sum=sum(value))

sankey4 %>% group_by(Notes) %>% 
  summarize(sum=sum(value))

sankey4 %>% group_by(StateFunds, Expenditures) %>% 
  summarize(sum=sum(value))
```

Graph below shows same amount in federal COVID dollars but here color indicates the fund that the money was received in.

```{r results='hold'}
sankeydata <- read_csv("sankeyattempt2022.csv") %>% filter(StFund == "Total")

sankey <- sankeydata %>% select(Federal, StateFunds, StFund, Expenditures, stfundname, value, Notes) %>%
  mutate(StateFunds = factor(StateFunds, levels = c("Total_received_fy20", "Total_received_fy21", "Total_received_fy22")),
         stfundname = as.factor(stfundname),
         Federal = as.factor(Federal),
         
                   Expenditures = factor(Expenditures, levels = c("Transit", "Medicaid", "Public Health",  "K-12", "Federal Other", "Community Development")),
         Notes = factor(Notes, levels = c( "Other *", "CARES","CRRSA", "ARPA")))


ggplot(sankey, 
       aes(y = value, axis3 = Federal, axis2 = stfundname, axis1=Expenditures, label = "stratum")) +
  geom_flow(aes(fill = stfundname), color = "black",reverse=FALSE) +
  guides(fill = FALSE) +   
  geom_stratum(reverse=FALSE)+
coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() +      
  geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse=FALSE)+
  ggtitle("Expenditures using Federal Relief Funds. ")

```

```{r include=FALSE}
sankeydata <- read_csv("sankeyattempt2022.csv") %>% filter(StFund == "Total_spent")

ggplot(sankey, 
       aes(y = value, axis3 = StateFunds, axis2 = stfundname, axis1=Expenditures, label = "stratum")) +
  geom_flow(aes(fill = stfundname), color = "black", reverse=FALSE) +
  # guides(fill = FALSE) +   
  geom_stratum(reverse=FALSE)+
  # geom_text(stat = "stratum", label.strata = TRUE) + 
  coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() +
     scale_x_discrete( limits = c("Federal Funds", "State Funds", "Expenditure Categories") )+ 
      geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 4)+
  ggtitle("")

```

Highlights legislation, fund money went into, and its purpose.

```{r results='hold'}

ggplot(sankey, 
       aes(y = value, axis3 = Notes, axis2 = stfundname, axis1=Expenditures, label = "stratum")) +
  geom_flow(aes(fill = stfundname), color = "black",reverse=FALSE) +
 # guides(fill = FALSE) +   
  geom_stratum(reverse=FALSE)+
 # geom_text(stat = "stratum", label.strata = TRUE) + 
coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() + ggtitle("Funds that received money from each law and their purpose.")


ggplot(sankey, 
       aes(y = value, axis3 = Notes, axis2 = stfundname, axis1=Expenditures, label = "stratum")) +
  geom_flow(aes(fill = stfundname), color = "black", reverse=FALSE) +
  geom_stratum(reverse=FALSE)+
coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() +
      geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2,reverse=FALSE)

```

```{r}
sankeydata <- read_csv("sankeyattempt2022.csv")

sankey <- sankeydata %>% select(Federal, StateFunds, StFund, Expenditures, stfundname, value, Notes) %>%
    filter(StFund == "Total") %>%

  mutate(StateFunds = factor(StateFunds, levels = c("Total_received_fy20", "Total_received_fy21", "Total_received_fy22")),
         stfundname = as.factor(stfundname),
         Federal = as.factor(Federal),
         
                   Expenditures = factor(Expenditures, levels = c("Community Development", "Public Health", "Medicaid", "K-12", "Federal Other", "Transit")),
         Notes = factor(Notes, levels = c(  "CARES", "Other *","CRRSA", "ARPA")))


ggplot(sankey, 
       aes(y = value, 
           axis3 = Notes, axis2 = StateFunds, axis1=Expenditures, label = "stratum")) +
  geom_flow(aes(fill = stfundname), color = "black", reverse=FALSE) +
  geom_stratum(reverse=FALSE)+
coord_flip()+
   scale_fill_brewer(palette = "YlOrRd", direction = -1)+
  theme_void() +
      geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2, reverse = FALSE)

```

> Note: CARES funds were originally received and spent in Disaster Response & Recovery Fund. In FY22, unspent aid was transferred to the State CURE and then transferred again to state agencies for COVID-related expenditures. Remaining CARES funds were transferred to State CURE fund for FY22. \$337 million was also transfered from the Illinois Department of Revenue into the Illinois Housing Development Authority (IHDA). ([LBOC June 2021 Report](https://budget.illinois.gov/content/dam/soi/en/web/budget/documents/lboc/lboc-report-june-2021-final.pdf))

> Revenue from Local Cure is the Local Government Transfers.

```{r results='hold'}
sankey %>%
  summarize(sum=sum(value))

sankey %>% group_by(StateFunds) %>% 
  summarize(sum=sum(value))

sankey %>% group_by(Expenditures) %>% 
  summarize(sum=sum(value))

sankey %>% group_by(Notes) %>% 
  summarize(sum=sum(value))

sankey %>% group_by(StateFunds, Expenditures) %>% 
  summarize(sum=sum(value))
```

[ggsankey info and example](https://cheatography.com/seleven/cheat-sheets/ggalluvial/)

![](images/image-2109120559.png){width="346"}
